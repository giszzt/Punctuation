<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Punctuation. / 标点</title>
    <!-- 引入核心库 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <style>
        /* 
         * DESIGN SYSTEM: THE ABSOLUTE
         * Philosophy: Reduction content-first, motion-driven.
         */

        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;500&family=Noto+Serif+SC:wght@300;500;700&display=swap');

        :root {
            /* 
             * PALETTE
             * We don't use "Blue" or "Red". We use Light and Absence.
             */
            --bg: #FAFAFA;
            --surface: #FFFFFF;
            --ink: #111111;
            --ink-secondary: #666666;
            --ink-tertiary: #AAAAAA;

            --accent: #111111;
            /* Brutalist Black */
            --accent-soft: rgba(0, 0, 0, 0.04);

            --line: #EAEAEA;
            --radius-sm: 8px;
            --radius-lg: 24px;

            --font-serif: "Noto Serif SC", serif;
            --font-mono: "JetBrains Mono", monospace;

            --ease-out-expo: cubic-bezier(0.16, 1, 0.3, 1);
        }

        @media (prefers-color-scheme: dark) {
            :root {
                --bg: #050505;
                --surface: #0A0A0A;
                --ink: #EDEDED;
                --ink-secondary: #888888;
                --ink-tertiary: #444444;

                --accent: #EDEDED;
                --accent-soft: rgba(255, 255, 255, 0.06);

                --line: #1F1F1F;
            }
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-font-smoothing: antialiased;
        }

        body {
            font-family: var(--font-serif);
            background-color: var(--bg);
            color: var(--ink);
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            transition: background 0.6s var(--ease-out-expo);
        }

        /* --- LAYOUT UTILS --- */
        .wrapper {
            flex: 1;
            display: flex;
            position: relative;
            z-index: 10;
        }

        /* --- TYPOGRAPHY --- */
        h1 {
            font-size: 14px;
            letter-spacing: 0.2em;
            text-transform: uppercase;
            font-family: var(--font-mono);
            font-weight: 500;
            color: var(--ink-secondary);
            margin-bottom: 0;
            /* Fixed: Removed large margin that blocked clicks */
        }

        .hero-text {
            font-size: 3rem;
            line-height: 1.2;
            font-weight: 300;
            margin-bottom: 2rem;
            opacity: 0;
            animation: slideUp 0.8s var(--ease-out-expo) 0.2s forwards;
        }

        /* --- NAVIGATION --- */
        nav {
            position: absolute;
            top: 2rem;
            left: 3rem;
            right: 3rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 50;
            pointer-events: none;
            /* Let clicks pass through empty nav areas */
        }

        /* Re-enable pointer events for interactive children */
        nav>* {
            pointer-events: auto;
        }


        .mode-switcher {
            display: flex;
            gap: 2rem;
        }

        .mode-btn {
            background: none;
            border: none;
            color: var(--ink-tertiary);
            font-family: var(--font-mono);
            font-size: 13px;
            cursor: pointer;
            padding-bottom: 4px;
            border-bottom: 1px solid transparent;
            transition: all 0.4s var(--ease-out-expo);
        }

        .mode-btn:hover {
            color: var(--ink);
        }

        .mode-btn.active {
            color: var(--ink);
            border-bottom-color: var(--ink);
        }

        /* --- STAGE: SPLIT VIEW --- */
        .stage {
            display: flex;
            width: 100%;
            height: 100%;
        }

        .pane-left,
        .pane-right {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 8rem 3rem 3rem;
            position: relative;
            transition: transform 0.6s var(--ease-out-expo);
        }

        .pane-left {
            border-right: 1px solid var(--line);
        }

        /* --- TEXT AREA (THE CANVAS) --- */
        .input-area {
            flex: 1;
            width: 100%;
            border: none;
            background: transparent;
            font-family: var(--font-serif);
            font-size: 1.25rem;
            line-height: 1.8;
            color: var(--ink);
            resize: none;
            outline: none;
            opacity: 0.8;
            transition: opacity 0.3s;
        }

        .input-area::placeholder {
            color: var(--ink-tertiary);
            font-weight: 300;
        }

        .input-area:focus {
            opacity: 1;
        }

        .pane-label {
            /* Removed absolute position to allow flex flow in header */
            position: static;
            font-family: var(--font-mono);
            font-size: 12px;
            color: var(--ink-tertiary);
            letter-spacing: 0.05em;
        }

        .pane-header {
            position: absolute;
            top: 6rem;
            left: 3rem;
            right: 3rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .copy-btn {
            background: none;
            border: 1px solid var(--line);
            border-radius: var(--radius-sm);
            padding: 4px 12px;
            font-family: var(--font-mono);
            font-size: 12px;
            color: var(--ink-secondary);
            cursor: pointer;
            transition: all 0.2s;
            opacity: 0;
            pointer-events: none;
        }

        .copy-btn.visible {
            opacity: 1;
            pointer-events: auto;
        }

        .copy-btn:hover {
            color: var(--ink);
            border-color: var(--ink-secondary);
        }

        .copy-btn.copied {
            background-color: var(--ink);
            color: var(--bg);
            border-color: var(--ink);
        }

        /* --- FILE UPLOAD (THE VOID) --- */
        .file-drop {
            display: none;
            /* Toggled via JS */
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--bg);
            z-index: 20;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .file-drop.active {
            display: flex;
        }

        .drop-target {
            width: 400px;
            height: 400px;
            border: 1px solid var(--line);
            border-radius: 50%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: all 0.6s var(--ease-out-expo);
            cursor: pointer;
            position: relative;
        }

        .drop-target::before {
            content: '';
            position: absolute;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            border: 1px solid var(--ink);
            opacity: 0;
            transform: scale(0.9);
            transition: all 0.6s var(--ease-out-expo);
        }

        .drop-target:hover::before,
        .drop-target.dragging::before {
            opacity: 0.1;
            transform: scale(1.1);
        }

        .drop-label {
            font-family: var(--font-mono);
            font-size: 14px;
            margin-top: 1rem;
            color: var(--ink-secondary);
        }

        .file-status {
            margin-top: 2rem;
            font-family: var(--font-serif);
            font-size: 1.5rem;
            text-align: center;
            height: 2rem;
        }

        /* --- BUTTONS --- */
        .action-btn {
            position: fixed;
            bottom: 3rem;
            left: 50%;
            transform: translateX(-50%);
            padding: 1rem 3rem;
            border-radius: 100px;
            background: var(--ink);
            color: var(--bg);
            border: none;
            font-family: var(--font-mono);
            font-size: 14px;
            letter-spacing: 0.05em;
            cursor: pointer;
            z-index: 100;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            transition: all 0.3s var(--ease-out-expo);
            opacity: 0;
            pointer-events: none;
        }

        .action-btn.visible {
            opacity: 1;
            pointer-events: auto;
            bottom: 4rem;
        }

        .action-btn:hover {
            transform: translateX(-50%) scale(1.05);
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.15);
        }

        /* --- ANIMATIONS --- */
        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .fade-in {
            animation: slideUp 0.6s var(--ease-out-expo) forwards;
        }
    </style>
</head>

<body>

    <nav>
        <h1>标点。</h1>
        <div class="mode-switcher">
            <button class="mode-btn active" id="btn-text">文本</button>
            <button class="mode-btn" id="btn-file">文档</button>
        </div>
    </nav>

    <!-- MODE: TEXT -->
    <div class="wrapper" id="view-text">
        <div class="stage">
            <div class="pane-left">
                <span class="pane-label">输入 / 原文</span>
                <textarea id="app-input" class="input-area" placeholder="在此粘贴文本。让逻辑完成剩余的工作。"></textarea>
            </div>
            <div class="pane-right">
                <div class="pane-header">
                    <span class="pane-label">输出 / 结果</span>
                    <button id="btn-copy" class="copy-btn">复制结果</button>
                </div>
                <textarea id="app-output" class="input-area" readonly placeholder="等待输入..."></textarea>
            </div>
        </div>
    </div>

    <!-- MODE: FILE -->
    <div class="file-drop" id="view-file">
        <div class="drop-target" id="drop-zone">
            <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                <path d="M12 5V19M12 5L6 11M12 5L18 11" stroke-linecap="square" />
            </svg>
            <div class="drop-label">点击或拖拽 DOCX 文档</div>
            <input type="file" id="file-input" hidden accept=".docx">
        </div>
        <div class="file-status" id="file-status"></div>
        <button class="action-btn" id="dl-btn">下载处理后的文档</button>
    </div>

    <script>
        /**
         * CORE LOGIC: THE ENGINE
         * Unchanged, because logic works. Design elevates it.
         */
        const PUNCT_MAP = {
            ',': '，', '.': '。', ':': '：', ';': '；',
            '?': '？', '!': '！', '(': '（', ')': '）'
        };

        function smartConvert(text) {
            if (!text) return "";

            text = text.replace(/([\u4e00-\u9fa5])\s*([,.:;?!])/g, (match, cn, punct) => cn + (PUNCT_MAP[punct] || punct));
            text = text.replace(/([,.:;?!])\s*([\u4e00-\u9fa5])/g, (match, punct, cn) => (PUNCT_MAP[punct] || punct) + cn);

            // Brackets
            text = text.replace(/\(\s*([\u4e00-\u9fa5])/g, (match, cn) => '（' + cn);
            text = text.replace(/([\u4e00-\u9fa5])\s*\)/g, (match, cn) => cn + '）');

            // Quotes Toggling (Stateless Regex approach for simple text is weaker, 
            // using the stateful approach from previous iteration is better for consistency)
            text = processQuotesStateful(text, '"', '“', '”');
            text = processQuotesStateful(text, "'", '‘', '’');

            return text;
        }

        // Stateful quote processor for plain text
        function processQuotesStateful(text, quote, open, close) {
            let result = "";
            let isOpen = false;
            const isHan = (char) => /[\u4e00-\u9fa5]/.test(char);

            for (let i = 0; i < text.length; i++) {
                const char = text[i];
                if (char === quote) {
                    const prev = text[i - 1] || '';
                    const next = text[i + 1] || '';
                    const isChinese = isHan(prev) || isHan(next);

                    if (isOpen) {
                        result += close;
                        isOpen = false;
                    } else if (isChinese) {
                        result += open;
                        isOpen = true;
                    } else {
                        result += quote;
                    }
                } else {
                    result += char;
                }
            }
            return result;
        }

        /* --- INTERACTION --- */
        const views = {
            text: document.getElementById('view-text'),
            file: document.getElementById('view-file')
        };
        const btns = {
            text: document.getElementById('btn-text'),
            file: document.getElementById('btn-file')
        };

        function switchView(mode) {
            // Toggle view visibility
            if (mode === 'text') {
                views.text.style.display = 'flex';
                views.file.classList.remove('active');
            } else {
                views.text.style.display = 'none';
                views.file.classList.add('active');
            }

            // Toggle nav state
            btns.text.classList.toggle('active', mode === 'text');
            btns.file.classList.toggle('active', mode === 'file');
        }

        btns.text.onclick = () => switchView('text');
        btns.file.onclick = () => switchView('file');

        /* --- COPY FUNCTIONALITY --- */
        const copyBtn = document.getElementById('btn-copy');
        const outputArea = document.getElementById('app-output');

        // Auto-show/hide copy button based on content
        function updateCopyState() {
            if (outputArea.value.trim().length > 0) {
                copyBtn.classList.add('visible');
            } else {
                copyBtn.classList.remove('visible');
            }
        }

        // Copy Action
        copyBtn.onclick = async () => {
            if (!outputArea.value) return;
            try {
                await navigator.clipboard.writeText(outputArea.value);
                const originalText = copyBtn.textContent;
                copyBtn.textContent = "已复制";
                copyBtn.classList.add('copied');

                setTimeout(() => {
                    copyBtn.textContent = originalText;
                    copyBtn.classList.remove('copied');
                }, 1500);
            } catch (err) {
                console.error('Failed to copy', err);
            }
        };

        /* --- TEXT MODE --- */
        const input = document.getElementById('app-input');
        // const output = document.getElementById('app-output'); // outputArea is already defined above

        input.addEventListener('input', () => {
            outputArea.value = smartConvert(input.value);
            updateCopyState();
        });

        /* --- FILE MODE --- */
        const dropZone = document.getElementById('drop-zone');
        const fileInput = document.getElementById('file-input');
        const status = document.getElementById('file-status');
        const dlBtn = document.getElementById('dl-btn');
        let dlBlob = null;
        let dlName = "";

        dropZone.onclick = () => fileInput.click();

        // Drag effects
        dropZone.ondragover = (e) => { e.preventDefault(); dropZone.classList.add('dragging'); };
        dropZone.ondragleave = () => dropZone.classList.remove('dragging');
        dropZone.ondrop = (e) => {
            e.preventDefault();
            dropZone.classList.remove('dragging');
            if (e.dataTransfer.files.length) handleFile(e.dataTransfer.files[0]);
        };
        fileInput.onchange = (e) => { if (e.target.files.length) handleFile(e.target.files[0]); };

        async function handleFile(file) {
            status.textContent = "正在解析文档结构...";
            status.style.opacity = 1;
            dlBtn.classList.remove('visible');

            try {
                const zip = await JSZip.loadAsync(file);
                const xmlFiles = [];
                zip.forEach((path) => { if (path.endsWith('.xml')) xmlFiles.push(path); });

                // DOM Based logic
                for (const path of xmlFiles) {
                    const content = await zip.file(path).async("string");
                    const parser = new DOMParser();
                    const xmlDoc = parser.parseFromString(content, "text/xml");
                    const paragraphs = xmlDoc.getElementsByTagName("w:p");

                    let hasChanges = false;

                    for (let i = 0; i < paragraphs.length; i++) {
                        const p = paragraphs[i];
                        const textNodes = p.getElementsByTagName("w:t");
                        if (!textNodes.length) continue;

                        let fullText = "";
                        const mapping = [];
                        for (let t = 0; t < textNodes.length; t++) {
                            const node = textNodes[t];
                            const txt = node.textContent;
                            for (let c = 0; c < txt.length; c++) mapping.push({ node, idx: c });
                            fullText += txt;
                        }

                        // Process - identical to previous "Fixing Quote Conversion Bug" logic
                        // Re-implementing simplified logic here to ensure self-contained file

                        // Simple Punctuation
                        const patterns = [
                            { r: /([\u4e00-\u9fa5])\s*([,.:;?!])/g, off: 1, map: PUNCT_MAP },
                            { r: /([,.:;?!])\s*([\u4e00-\u9fa5])/g, off: 0, map: PUNCT_MAP },
                            { r: /\(\s*([\u4e00-\u9fa5])/g, off: 0, rep: '（' },
                            { r: /([\u4e00-\u9fa5])\s*\)/g, off: 1, rep: '）' }
                        ];

                        patterns.forEach(pat => {
                            let m; pat.r.lastIndex = 0;
                            while (m = pat.r.exec(fullText)) {
                                const targetIdx = pat.off === 0 ? m.index : (m.index + m[0].length - 1);
                                const rep = pat.map ? pat.map[pat.off === 0 ? m[1] : m[2]] : pat.rep;
                                modify(targetIdx, rep, mapping);
                                hasChanges = true;
                            }
                        });

                        // Quotes
                        if (processQuoteInPlace(fullText, '"', '“', '”', mapping)) hasChanges = true;
                        if (processQuoteInPlace(fullText, "'", '‘', '’', mapping)) hasChanges = true;
                    }

                    if (hasChanges) {
                        zip.file(path, new XMLSerializer().serializeToString(xmlDoc));
                    }
                }

                dlBlob = await zip.generateAsync({ type: "blob" });
                dlName = "已转换_" + file.name;

                status.textContent = file.name;
                dlBtn.textContent = "下载处理后的文档";
                dlBtn.classList.add('visible');

            } catch (e) {
                console.error(e);
                status.textContent = "文档结构不兼容。";
            }
        }

        function modify(idx, char, map) {
            if (idx >= 0 && idx < map.length) {
                const { node, idx: nIdx } = map[idx];
                const arr = node.textContent.split('');
                if (arr[nIdx] !== char) {
                    arr[nIdx] = char;
                    node.textContent = arr.join('');
                }
            }
        }

        function processQuoteInPlace(text, quote, open, close, map) {
            let changed = false;
            let isOpen = false;
            const isHan = (c) => /[\u4e00-\u9fa5]/.test(c);

            for (let i = 0; i < text.length; i++) {
                if (text[i] === quote) {
                    const prev = text[i - 1] || '';
                    const next = text[i + 1] || '';
                    const cnCtx = isHan(prev) || isHan(next);

                    if (isOpen) {
                        modify(i, close, map);
                        isOpen = false;
                        changed = true;
                    } else if (cnCtx) {
                        modify(i, open, map);
                        isOpen = true;
                        changed = true;
                    }
                }
            }
            return changed;
        }

        dlBtn.onclick = () => saveAs(dlBlob, dlName);

    </script>
</body>

</html>